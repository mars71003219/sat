#!/usr/bin/env python3
"""
ì¸ê³µìœ„ì„± í…”ë ˆë©”íŠ¸ë¦¬ ë°ì´í„° ì‹œë®¬ë ˆì´í„°
ì‹¤ì œ ìœ„ì„± ë°ì´í„° ì†¡ìˆ˜ì‹  íŠ¹ì„±ì„ ëª¨ì‚¬í•˜ì—¬ 6ê°€ì§€ ì£¼ìš” ì„œë¸Œì‹œìŠ¤í…œì˜ í…”ë ˆë©”íŠ¸ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

Docker ì‹¤í–‰:
  docker run -d --rm \
    --name satellite-simulator \
    --network satellite_webnet \
    -v /mnt/c/projects/satellite/tests:/tests \
    -w /tests \
    python:3.10-slim \
    bash -c "pip install -q confluent-kafka && python satellite_simulator.py --kafka kafka:9092"

CLI ì˜ˆì‹œ:
  python satellite_simulator.py --kafka localhost:9092 --satellites 10 --interval 5 --duration 5400
"""

import json
import math
import random
import time
import argparse
from datetime import datetime, timezone
from typing import Dict, Any, List
from confluent_kafka import Producer
from dataclasses import dataclass, asdict
from enum import Enum


class SatelliteMode(Enum):
    """ìœ„ì„± ìš´ìš© ëª¨ë“œ"""
    SAFE = "safe"  # ì•ˆì „ ëª¨ë“œ (ìµœì†Œ ê¸°ëŠ¥)
    NOMINAL = "nominal"  # ì •ìƒ ìš´ìš©
    PAYLOAD_ACTIVE = "payload_active"  # íƒ‘ì¬ì²´ ì‘ë™ ì¤‘
    MANEUVER = "maneuver"  # ê¶¤ë„ ì¡°ì • ì¤‘
    ECLIPSE = "eclipse"  # ì‹(Eclipse) êµ¬ê°„


@dataclass
class BeaconData:
    """ğŸ›°ï¸ ë¹„ì½˜ (Beacon) - ìœ„ì„± ìƒì¡´ ì‹ í˜¸"""
    alive: bool = True
    uptime_seconds: int = 0
    mode: str = SatelliteMode.NOMINAL.value
    last_command_time: str = None


@dataclass
class OBCStatus:
    """ğŸ–¥ï¸ ì˜¨ë³´ë“œ ì»´í“¨í„° (On-Board Computer)"""
    cpu_usage_percent: float = 0.0
    memory_usage_percent: float = 0.0
    uptime_seconds: int = 0
    error_count: int = 0
    boot_count: int = 1
    onboard_time: str = None


@dataclass
class EPSStatus:
    """âš¡ ì „ë ¥ ì‹œìŠ¤í…œ (Electrical Power System)"""
    # ë°°í„°ë¦¬
    battery_soc_percent: float = 0.0  # State of Charge
    battery_voltage: float = 0.0
    battery_current: float = 0.0
    battery_temperature: float = 0.0

    # íƒœì–‘ ì „ì§€íŒ (ê° íŒ¨ë„ë³„)
    solar_panel_1_voltage: float = 0.0
    solar_panel_1_current: float = 0.0
    solar_panel_2_voltage: float = 0.0
    solar_panel_2_current: float = 0.0
    solar_panel_3_voltage: float = 0.0
    solar_panel_3_current: float = 0.0

    # ì „ë ¥ ë¶„ë°°
    obc_power_watts: float = 0.0
    comm_power_watts: float = 0.0
    payload_power_watts: float = 0.0
    total_power_consumption: float = 0.0
    total_power_generation: float = 0.0


@dataclass
class ThermalStatus:
    """ğŸ”¥ ì˜¨ë„ ê´€ë¦¬ ì‹œìŠ¤í…œ (Thermal Control System)"""
    battery_temp: float = 0.0
    obc_temp: float = 0.0
    comm_temp: float = 0.0
    payload_temp: float = 0.0
    solar_panel_temp: float = 0.0
    external_temp: float = 0.0

    heater_1_on: bool = False
    heater_2_on: bool = False
    cooler_active: bool = False


@dataclass
class AOCSStatus:
    """ğŸ§­ ìì„¸ ë° ê¶¤ë„ ì œì–´ (Attitude & Orbit Control System)"""
    # ìì„¸ ì„¼ì„œ
    gyro_x: float = 0.0  # ê°ì†ë„ (deg/s)
    gyro_y: float = 0.0
    gyro_z: float = 0.0

    sun_sensor_angle: float = 0.0  # íƒœì–‘ ê°ë„
    magnetometer_x: float = 0.0  # ìê¸°ì¥ (Î¼T)
    magnetometer_y: float = 0.0
    magnetometer_z: float = 0.0

    # ìì„¸ ì œì–´ ì¥ì¹˜
    reaction_wheel_1_rpm: float = 0.0
    reaction_wheel_2_rpm: float = 0.0
    reaction_wheel_3_rpm: float = 0.0

    # ì¶”ì§„ì²´
    thruster_fuel_percent: float = 100.0
    thruster_pressure_bar: float = 0.0
    thruster_temperature: float = 0.0
    thruster_active: bool = False

    # ê¶¤ë„ ì •ë³´ (GPS)
    gps_latitude: float = 0.0
    gps_longitude: float = 0.0
    gps_altitude_km: float = 0.0
    gps_velocity_kmps: float = 0.0


@dataclass
class CommStatus:
    """ğŸ“¡ í†µì‹  ì‹œìŠ¤í…œ (Communication System)"""
    rssi_dbm: float = 0.0  # ì‹ í˜¸ ê°•ë„
    tx_active: bool = False  # ì†¡ì‹  ì¤‘
    rx_active: bool = False  # ìˆ˜ì‹  ì¤‘
    data_backlog_mb: float = 0.0  # ë¯¸ì „ì†¡ ë°ì´í„°
    last_contact_seconds_ago: int = 0


@dataclass
class PayloadStatus:
    """ğŸ”¬ íƒ‘ì¬ì²´ (Payload)"""
    camera_on: bool = False
    sensor_on: bool = False
    payload_temp: float = 0.0
    payload_power_watts: float = 0.0
    last_image_time: str = None
    images_captured_count: int = 0


class RealisticSatelliteSimulator:
    """
    ì‹¤ì œ ìœ„ì„± í…”ë ˆë©”íŠ¸ë¦¬ ì‹œë®¬ë ˆì´í„°

    6ê°€ì§€ ì£¼ìš” ì„œë¸Œì‹œìŠ¤í…œì„ ì‹œë®¬ë ˆì´ì…˜:
    1. ë¹„ì½˜ & OBC (Health & Status)
    2. ì „ë ¥ ì‹œìŠ¤í…œ (EPS)
    3. ì˜¨ë„ ê´€ë¦¬ (TCS)
    4. ìì„¸/ê¶¤ë„ ì œì–´ (AOCS)
    5. í†µì‹  ì‹œìŠ¤í…œ (Comm)
    6. íƒ‘ì¬ì²´ (Payload)
    """

    def __init__(self, satellite_id: str, kafka_servers: str):
        self.satellite_id = satellite_id
        self.kafka_topic = 'satellite-telemetry'

        # Kafka Producer
        self.producer = Producer({
            'bootstrap.servers': kafka_servers,
            'client.id': f'sat-sim-{satellite_id}'
        })

        # ì‹œë®¬ë ˆì´ì…˜ ìƒíƒœ
        self.time_elapsed = 0  # ì´ˆ
        self.orbit_period = 5400  # 90ë¶„ (LEO ê¶¤ë„)
        self.orbital_position = random.uniform(0, 360)  # ê¶¤ë„ìƒ ìœ„ì¹˜ (ë„)

        # ìœ„ì„± ëª¨ë“œ
        self.mode = SatelliteMode.NOMINAL

        # ì„œë¸Œì‹œìŠ¤í…œ ìƒíƒœ
        self.beacon = BeaconData()
        self.obc = OBCStatus()
        self.eps = EPSStatus()
        self.thermal = ThermalStatus()
        self.aocs = AOCSStatus()
        self.comm = CommStatus()
        self.payload = PayloadStatus()

        # ì´ë²¤íŠ¸ ìƒíƒœ
        self.in_eclipse = False  # ì§€êµ¬ ê·¸ë¦¼ì
        self.maneuver_active = False
        self.maneuver_end_time = 0
        self.last_maneuver_time = -10000

        print(f"[{satellite_id}] Satellite Simulator initialized")

    def _is_in_eclipse(self) -> bool:
        """ì§€êµ¬ ê·¸ë¦¼ì(Eclipse) êµ¬ê°„ íŒì •"""
        # ê¶¤ë„ì˜ ì•½ 30% êµ¬ê°„ì´ ê·¸ë¦¼ì (108ë„)
        return 252 < (self.orbital_position % 360) < 360

    def _get_sun_angle(self) -> float:
        """íƒœì–‘ ê°ë„ ê³„ì‚° (0~180ë„)"""
        if self.in_eclipse:
            return 180.0
        orbit_phase = (self.time_elapsed % self.orbit_period) / self.orbit_period
        return abs(180 * math.cos(2 * math.pi * orbit_phase))

    def update_beacon_obc(self):
        """ë¹„ì½˜ ë° OBC ìƒíƒœ ì—…ë°ì´íŠ¸"""
        self.beacon.alive = True
        self.beacon.uptime_seconds = self.time_elapsed
        self.beacon.mode = self.mode.value
        self.beacon.last_command_time = datetime.now(timezone.utc).isoformat()

        # OBC CPU/ë©”ëª¨ë¦¬ ì‚¬ìš©ë¥ 
        base_cpu = 30.0
        if self.mode == SatelliteMode.PAYLOAD_ACTIVE:
            base_cpu = 70.0
        elif self.mode == SatelliteMode.MANEUVER:
            base_cpu = 50.0

        self.obc.cpu_usage_percent = round(base_cpu + random.gauss(0, 5), 2)
        self.obc.memory_usage_percent = round(45 + random.gauss(0, 10), 2)
        self.obc.uptime_seconds = self.time_elapsed
        self.obc.onboard_time = datetime.now(timezone.utc).isoformat()

        # ê°„í—ì  ì—ëŸ¬ ë°œìƒ (1% í™•ë¥ )
        if random.random() < 0.01:
            self.obc.error_count += 1

    def update_eps(self):
        """ì „ë ¥ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸"""
        # ë°°í„°ë¦¬ ì¶©/ë°©ì „
        if self.in_eclipse:
            # ë°©ì „ ì¤‘
            discharge_rate = 0.5  # %/ë¶„
            self.eps.battery_soc_percent = max(20, self.eps.battery_soc_percent - discharge_rate * 0.1)
            self.eps.battery_current = random.uniform(-2.5, -1.8)  # ë°©ì „ ì „ë¥˜
        else:
            # ì¶©ì „ ì¤‘
            charge_rate = 0.8
            self.eps.battery_soc_percent = min(100, self.eps.battery_soc_percent + charge_rate * 0.1)
            self.eps.battery_current = random.uniform(1.5, 2.8)  # ì¶©ì „ ì „ë¥˜

        # ë°°í„°ë¦¬ ì „ì•• (ë¦¬íŠ¬ì´ì˜¨ 3.0V~4.2V)
        self.eps.battery_voltage = 3.0 + (self.eps.battery_soc_percent / 100) * 1.2
        self.eps.battery_voltage += random.gauss(0, 0.05)

        # ë°°í„°ë¦¬ ì˜¨ë„
        self.eps.battery_temperature = 15 + random.gauss(0, 5)
        if self.eps.battery_current > 2.0:  # ê¸‰ì† ì¶©ì „ ì‹œ ì˜¨ë„ ìƒìŠ¹
            self.eps.battery_temperature += 5

        # íƒœì–‘ ì „ì§€íŒ ì¶œë ¥
        if self.in_eclipse:
            # ê·¸ë¦¼ì: ì¶œë ¥ ì—†ìŒ
            self.eps.solar_panel_1_voltage = 0.0
            self.eps.solar_panel_1_current = 0.0
            self.eps.solar_panel_2_voltage = 0.0
            self.eps.solar_panel_2_current = 0.0
            self.eps.solar_panel_3_voltage = 0.0
            self.eps.solar_panel_3_current = 0.0
        else:
            # íƒœì–‘ê´‘: ê°ë„ì— ë”°ë¥¸ ì¶œë ¥
            sun_angle = self._get_sun_angle()
            efficiency = max(0, math.cos(math.radians(sun_angle)))

            base_voltage = 8.0
            base_current = 2.5

            for i in range(1, 4):
                # íŒ¨ë„ë§ˆë‹¤ ì•½ê°„ì˜ ì°¨ì´
                panel_efficiency = efficiency * random.uniform(0.9, 1.0)
                setattr(self.eps, f'solar_panel_{i}_voltage', round(base_voltage * panel_efficiency, 2))
                setattr(self.eps, f'solar_panel_{i}_current', round(base_current * panel_efficiency, 2))

        # ì „ë ¥ ì†Œë¹„
        self.eps.obc_power_watts = 12 + random.gauss(0, 2)
        self.eps.comm_power_watts = 8 if self.comm.tx_active else 3
        self.eps.payload_power_watts = 25 if self.payload.camera_on else 0

        if self.maneuver_active:
            self.eps.obc_power_watts += 15  # ì¶”ì§„ ì‹œìŠ¤í…œ ì „ë ¥

        self.eps.total_power_consumption = (
            self.eps.obc_power_watts +
            self.eps.comm_power_watts +
            self.eps.payload_power_watts
        )

        self.eps.total_power_generation = (
            self.eps.solar_panel_1_voltage * self.eps.solar_panel_1_current +
            self.eps.solar_panel_2_voltage * self.eps.solar_panel_2_current +
            self.eps.solar_panel_3_voltage * self.eps.solar_panel_3_current
        )

        # ë°˜ì˜¬ë¦¼
        self.eps.battery_soc_percent = round(self.eps.battery_soc_percent, 2)
        self.eps.battery_voltage = round(self.eps.battery_voltage, 2)
        self.eps.battery_current = round(self.eps.battery_current, 2)
        self.eps.total_power_consumption = round(self.eps.total_power_consumption, 2)
        self.eps.total_power_generation = round(self.eps.total_power_generation, 2)

    def update_thermal(self):
        """ì˜¨ë„ ê´€ë¦¬ ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸"""
        # ê¸°ë³¸ ì˜¨ë„ (ìš°ì£¼ ë°°ê²½ ë³µì‚¬)
        base_temp = -20 if self.in_eclipse else 20

        # ê° ë¶€í’ˆ ì˜¨ë„
        self.thermal.battery_temp = self.eps.battery_temperature
        self.thermal.obc_temp = base_temp + 30 + random.gauss(0, 5)  # CPU ë°œì—´
        self.thermal.comm_temp = base_temp + 15 + random.gauss(0, 3)
        self.thermal.payload_temp = base_temp + (20 if self.payload.camera_on else 5)
        self.thermal.solar_panel_temp = base_temp + random.gauss(0, 10)
        self.thermal.external_temp = base_temp + random.gauss(0, 15)

        # íˆí„° ì œì–´ (ì˜¨ë„ê°€ ë‚®ìœ¼ë©´ ì‘ë™)
        self.thermal.heater_1_on = self.thermal.battery_temp < 0
        self.thermal.heater_2_on = self.thermal.obc_temp < -10

        # ì¿¨ëŸ¬ ì œì–´ (ì˜¨ë„ê°€ ë†’ìœ¼ë©´ ì‘ë™)
        self.thermal.cooler_active = self.thermal.obc_temp > 60

        # ë°˜ì˜¬ë¦¼
        for attr in ['battery_temp', 'obc_temp', 'comm_temp', 'payload_temp', 'solar_panel_temp', 'external_temp']:
            setattr(self.thermal, attr, round(getattr(self.thermal, attr), 2))

    def update_aocs(self):
        """ìì„¸ ë° ê¶¤ë„ ì œì–´ ì—…ë°ì´íŠ¸"""
        # ìì´ë¡œìŠ¤ì½”í”„ (ê°ì†ë„)
        if self.maneuver_active:
            self.aocs.gyro_x = random.gauss(5, 1)
            self.aocs.gyro_y = random.gauss(3, 0.5)
            self.aocs.gyro_z = random.gauss(2, 0.5)
        else:
            self.aocs.gyro_x = random.gauss(0, 0.1)
            self.aocs.gyro_y = random.gauss(0, 0.1)
            self.aocs.gyro_z = random.gauss(0, 0.1)

        # íƒœì–‘ ì„¼ì„œ
        self.aocs.sun_sensor_angle = self._get_sun_angle()

        # ìê¸°ì¥ ì„¼ì„œ (ì§€êµ¬ ìê¸°ì¥ 30~60Î¼T)
        orbit_phase = (self.time_elapsed % self.orbit_period) / self.orbit_period
        self.aocs.magnetometer_x = 40 * math.sin(2 * math.pi * orbit_phase) + random.gauss(0, 2)
        self.aocs.magnetometer_y = 35 * math.cos(2 * math.pi * orbit_phase) + random.gauss(0, 2)
        self.aocs.magnetometer_z = 50 + random.gauss(0, 5)

        # ë¦¬ì•¡ì…˜ íœ  (íšŒì „ ì†ë„)
        base_rpm = 3000
        self.aocs.reaction_wheel_1_rpm = base_rpm + random.gauss(0, 100)
        self.aocs.reaction_wheel_2_rpm = base_rpm + random.gauss(0, 100)
        self.aocs.reaction_wheel_3_rpm = base_rpm + random.gauss(0, 100)

        # ì¶”ì§„ì²´ (Thruster)
        if not self.maneuver_active and self.time_elapsed - self.last_maneuver_time > 1800:
            # 30ë¶„ë§ˆë‹¤ 0.5% í™•ë¥ ë¡œ ê¶¤ë„ ì¡°ì •
            if random.random() < 0.005:
                self.maneuver_active = True
                self.maneuver_end_time = self.time_elapsed + random.uniform(30, 90)
                self.last_maneuver_time = self.time_elapsed
                self.mode = SatelliteMode.MANEUVER
                print(f"  [{self.satellite_id}] Orbital maneuver started!")

        if self.maneuver_active:
            if self.time_elapsed < self.maneuver_end_time:
                self.aocs.thruster_active = True
                self.aocs.thruster_pressure_bar = 200 + random.gauss(0, 10)
                self.aocs.thruster_temperature = 600 + random.gauss(0, 50)
                self.aocs.thruster_fuel_percent -= 0.01  # ì—°ë£Œ ì†Œëª¨
            else:
                self.maneuver_active = False
                self.aocs.thruster_active = False
                self.mode = SatelliteMode.NOMINAL
                print(f"  [{self.satellite_id}] Orbital maneuver completed")
        else:
            self.aocs.thruster_active = False
            self.aocs.thruster_pressure_bar = 0
            self.aocs.thruster_temperature = 20 + random.gauss(0, 5)

        # GPS ê¶¤ë„ ì •ë³´
        orbit_phase = (self.time_elapsed % self.orbit_period) / self.orbit_period

        # ìœ„ë„ (ê¶¤ë„ ê²½ì‚¬ê° 51.6ë„)
        inclination = 51.6
        self.aocs.gps_latitude = inclination * math.sin(2 * math.pi * orbit_phase)

        # ê²½ë„ (ì§€êµ¬ ìì „ ê³ ë ¤)
        self.aocs.gps_longitude = (self.orbital_position % 360) - 180

        # ê³ ë„ (400~450km, íƒ€ì› ê¶¤ë„)
        mean_altitude = 425
        self.aocs.gps_altitude_km = mean_altitude + 25 * math.cos(2 * math.pi * orbit_phase)

        # ì†ë„ (7.66 km/s, ê³ ë„ì— ë°˜ë¹„ë¡€)
        self.aocs.gps_velocity_kmps = 7.66 + 0.1 * math.sin(2 * math.pi * orbit_phase)

        # ë°˜ì˜¬ë¦¼
        self.aocs.gyro_x = round(self.aocs.gyro_x, 3)
        self.aocs.gyro_y = round(self.aocs.gyro_y, 3)
        self.aocs.gyro_z = round(self.aocs.gyro_z, 3)
        self.aocs.sun_sensor_angle = round(self.aocs.sun_sensor_angle, 2)
        self.aocs.magnetometer_x = round(self.aocs.magnetometer_x, 2)
        self.aocs.magnetometer_y = round(self.aocs.magnetometer_y, 2)
        self.aocs.magnetometer_z = round(self.aocs.magnetometer_z, 2)
        self.aocs.thruster_fuel_percent = round(self.aocs.thruster_fuel_percent, 2)
        self.aocs.gps_latitude = round(self.aocs.gps_latitude, 4)
        self.aocs.gps_longitude = round(self.aocs.gps_longitude, 4)
        self.aocs.gps_altitude_km = round(self.aocs.gps_altitude_km, 2)
        self.aocs.gps_velocity_kmps = round(self.aocs.gps_velocity_kmps, 3)

    def update_comm(self):
        """í†µì‹  ì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸"""
        # ì‹ í˜¸ ê°•ë„ (RSSI)
        # ì§€ìƒêµ­ ê°€ì‹œê¶Œ ì—¬ë¶€ (ìœ„ë„ê°€ íŠ¹ì • ë²”ìœ„ì¼ ë•Œ)
        visible_to_ground = abs(self.aocs.gps_latitude) < 60

        if visible_to_ground:
            self.comm.rssi_dbm = random.uniform(-85, -70)  # ì¢‹ì€ ì‹ í˜¸
            self.comm.rx_active = True

            # 10% í™•ë¥ ë¡œ ë°ì´í„° ì†¡ì‹ 
            if random.random() < 0.1:
                self.comm.tx_active = True
                self.comm.data_backlog_mb = max(0, self.comm.data_backlog_mb - 5)
            else:
                self.comm.tx_active = False

            self.comm.last_contact_seconds_ago = 0
        else:
            self.comm.rssi_dbm = random.uniform(-120, -100)  # ì•½í•œ ì‹ í˜¸
            self.comm.rx_active = False
            self.comm.tx_active = False
            self.comm.last_contact_seconds_ago += 5

        # ë°ì´í„° ë°±ë¡œê·¸ ëˆ„ì  (íƒ‘ì¬ì²´ ì‘ë™ ì‹œ)
        if self.payload.camera_on:
            self.comm.data_backlog_mb += 2.5  # ì´ë¯¸ì§€ 1ì¥ = 2.5MB

        self.comm.rssi_dbm = round(self.comm.rssi_dbm, 1)
        self.comm.data_backlog_mb = round(self.comm.data_backlog_mb, 2)

    def update_payload(self):
        """íƒ‘ì¬ì²´ ì—…ë°ì´íŠ¸"""
        # íƒ‘ì¬ì²´ ì‘ë™ ì¡°ê±´: ë°°í„°ë¦¬ ì¶©ë¶„ + ì§€êµ¬ ê°€ì‹œê¶Œ
        can_operate = (self.eps.battery_soc_percent > 40 and
                      not self.in_eclipse and
                      abs(self.aocs.gps_latitude) < 70)

        if can_operate and random.random() < 0.05:
            # 5% í™•ë¥ ë¡œ ì´¬ì˜
            self.payload.camera_on = True
            self.payload.sensor_on = True
            self.mode = SatelliteMode.PAYLOAD_ACTIVE
            self.payload.images_captured_count += 1
            self.payload.last_image_time = datetime.now(timezone.utc).isoformat()
            print(f"  [{self.satellite_id}] Image captured! (Total: {self.payload.images_captured_count})")
        else:
            self.payload.camera_on = False
            self.payload.sensor_on = False
            if self.mode == SatelliteMode.PAYLOAD_ACTIVE:
                self.mode = SatelliteMode.NOMINAL

        self.payload.payload_temp = self.thermal.payload_temp
        self.payload.payload_power_watts = self.eps.payload_power_watts

    def generate_telemetry(self) -> Dict[str, Any]:
        """ì „ì²´ í…”ë ˆë©”íŠ¸ë¦¬ ë°ì´í„° ìƒì„±"""
        # Eclipse ìƒíƒœ ì—…ë°ì´íŠ¸
        self.in_eclipse = self._is_in_eclipse()
        if self.in_eclipse and self.mode == SatelliteMode.NOMINAL:
            self.mode = SatelliteMode.ECLIPSE
        elif not self.in_eclipse and self.mode == SatelliteMode.ECLIPSE:
            self.mode = SatelliteMode.NOMINAL

        # ê° ì„œë¸Œì‹œìŠ¤í…œ ì—…ë°ì´íŠ¸
        self.update_beacon_obc()
        self.update_eps()
        self.update_thermal()
        self.update_aocs()
        self.update_comm()
        self.update_payload()

        # í…”ë ˆë©”íŠ¸ë¦¬ íŒ¨í‚· ìƒì„±
        telemetry = {
            'timestamp': datetime.now(timezone.utc).isoformat(),
            'satellite_id': self.satellite_id,
            'beacon': asdict(self.beacon),
            'obc': asdict(self.obc),
            'eps': asdict(self.eps),
            'thermal': asdict(self.thermal),
            'aocs': asdict(self.aocs),
            'comm': asdict(self.comm),
            'payload': asdict(self.payload)
        }

        return telemetry

    def send_to_kafka(self, telemetry: Dict[str, Any]):
        """Kafkaë¡œ ì „ì†¡"""
        try:
            message = json.dumps(telemetry)
            self.producer.produce(
                self.kafka_topic,
                key=self.satellite_id.encode('utf-8'),
                value=message.encode('utf-8')
            )
            self.producer.poll(0)
        except Exception as e:
            print(f"[{self.satellite_id}] Kafka error: {e}")

    def update_orbital_state(self, time_step: float):
        """ê¶¤ë„ ìƒíƒœ ì—…ë°ì´íŠ¸"""
        self.time_elapsed += int(time_step)
        angular_velocity = 360 / self.orbit_period
        self.orbital_position = (self.orbital_position + angular_velocity * time_step) % 360


def run_multi_satellite_simulation(
    num_satellites: int = 10,
    kafka_servers: str = 'localhost:9092',
    interval: int = 5,
    duration: int = 5400  # 90ë¶„
):
    """
    ë‹¤ì¤‘ ìœ„ì„± ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰

    Args:
        num_satellites: ìœ„ì„± ê°œìˆ˜ (ê¸°ë³¸ê°’: 10)
        kafka_servers: Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ
        interval: ì „ì†¡ ì£¼ê¸° (ì´ˆ, ê¸°ë³¸ê°’: 5)
        duration: ì´ ì‹¤í–‰ ì‹œê°„ (ì´ˆ, ê¸°ë³¸ê°’: 5400 = 90ë¶„)
    """
    print("=" * 80)
    print("ğŸ›°ï¸  ì¸ê³µìœ„ì„± í…”ë ˆë©”íŠ¸ë¦¬ ì‹œë®¬ë ˆì´í„°")
    print("=" * 80)
    print(f"ìœ„ì„± ê°œìˆ˜:     {num_satellites}")
    print(f"ì „ì†¡ ì£¼ê¸°:     {interval}ì´ˆ")
    print(f"ì‹¤í–‰ ì‹œê°„:     {duration}ì´ˆ ({duration/60:.1f}ë¶„)")
    print(f"Kafka:        {kafka_servers}")
    print("=" * 80)
    print()

    # ìœ„ì„± ì‹œë®¬ë ˆì´í„° ìƒì„±
    satellites: List[RealisticSatelliteSimulator] = []
    for i in range(num_satellites):
        sat_id = f"SAT-{i+1:03d}"
        simulator = RealisticSatelliteSimulator(sat_id, kafka_servers)
        # ê° ìœ„ì„±ì˜ ê¶¤ë„ ìœ„ì¹˜ë¥¼ ë¶„ì‚°
        simulator.orbital_position = (360 / num_satellites) * i
        # ë°°í„°ë¦¬ ì´ˆê¸° SoCë¥¼ ëœë¤í™”
        simulator.eps.battery_soc_percent = random.uniform(60, 95)
        satellites.append(simulator)

    print(f"\nâœ… {num_satellites}ê°œ ìœ„ì„± ì´ˆê¸°í™” ì™„ë£Œ\n")

    # ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
    iteration = 0
    start_time = time.time()

    try:
        while True:
            iteration += 1
            current_time = time.time()

            # ì¢…ë£Œ ì¡°ê±´
            if (current_time - start_time) >= duration:
                print(f"\nâœ… ì‹œë®¬ë ˆì´ì…˜ ì™„ë£Œ ({duration}ì´ˆ)")
                break

            # ì „ì²´ ìœ„ì„± í…”ë ˆë©”íŠ¸ë¦¬ ìƒì„± ë° ì „ì†¡
            print(f"[{iteration:04d}] {datetime.now(timezone.utc).strftime('%H:%M:%S')} | "
                  f"Elapsed: {int(current_time - start_time)}s / {duration}s")

            for sat in satellites:
                telemetry = sat.generate_telemetry()
                sat.send_to_kafka(telemetry)
                sat.update_orbital_state(interval)

            # ë‹¤ìŒ ì£¼ê¸°ê¹Œì§€ ëŒ€ê¸°
            time.sleep(interval)

    except KeyboardInterrupt:
        print("\n\nâš ï¸  ì‹œë®¬ë ˆì´í„° ì¤‘ì§€ (Ctrl+C)")

    finally:
        # Kafka producer ì •ë¦¬
        print(f"\nğŸ“Š í†µê³„:")
        print(f"  ì´ ë°˜ë³µ:     {iteration}")
        print(f"  ì´ ë©”ì‹œì§€:   {iteration * num_satellites}")
        print(f"  ì‹¤í–‰ ì‹œê°„:   {int(time.time() - start_time)}ì´ˆ")
        print("\nKafka producer flushing...")
        for sat in satellites:
            sat.producer.flush()
        print("âœ… Shutdown complete")


def main():
    parser = argparse.ArgumentParser(
        description='ì¸ê³µìœ„ì„± í…”ë ˆë©”íŠ¸ë¦¬ ì‹œë®¬ë ˆì´í„° (ì‹¤ì œ ìœ„ì„± ë°ì´í„° íŠ¹ì„± ëª¨ì‚¬)',
        formatter_class=argparse.RawDescriptionHelpFormatter,
        epilog="""
ì˜ˆì‹œ:
  # ê¸°ë³¸ ì‹¤í–‰ (10ê°œ ìœ„ì„±, 5ì´ˆ ì£¼ê¸°, 90ë¶„)
  python satellite_simulator.py --kafka kafka:9092

  # ì‚¬ìš©ì ì •ì˜
  python satellite_simulator.py --kafka localhost:9092 --satellites 5 --interval 10 --duration 3600
        """
    )

    parser.add_argument(
        '--kafka',
        type=str,
        default='localhost:9092',
        help='Kafka ë¸Œë¡œì»¤ ì£¼ì†Œ (ê¸°ë³¸ê°’: localhost:9092)'
    )

    parser.add_argument(
        '--satellites',
        type=int,
        default=10,
        help='ìœ„ì„± ê°œìˆ˜ (ê¸°ë³¸ê°’: 10)'
    )

    parser.add_argument(
        '--interval',
        type=int,
        default=5,
        help='ë°ì´í„° ì „ì†¡ ì£¼ê¸° (ì´ˆ, ê¸°ë³¸ê°’: 5)'
    )

    parser.add_argument(
        '--duration',
        type=int,
        default=5400,
        help='ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰ ì‹œê°„ (ì´ˆ, ê¸°ë³¸ê°’: 5400 = 90ë¶„)'
    )

    args = parser.parse_args()

    # ì‹œë®¬ë ˆì´ì…˜ ì‹¤í–‰
    run_multi_satellite_simulation(
        num_satellites=args.satellites,
        kafka_servers=args.kafka,
        interval=args.interval,
        duration=args.duration
    )


if __name__ == '__main__':
    main()
